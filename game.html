<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Untitled</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>REBOND â€” Puzzle (Prototype)</title>
<style>
  :root{
    --teal:#14786c;
    --amber:#edb01a;
    --ink:#0f172a;
    --muted:#475569;
    --bg:#f7faf9;
    --card:#ffffff;
    --line:rgba(15, 23, 42, .12);
    --good:rgba(20,120,108,.12);
    --bad:rgba(220, 38, 38, .10);
    --info:rgba(2, 132, 199, .10);
    --shadow: 0 10px 28px rgba(2,6,23,.08);
    --radius:18px;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
    color:var(--ink);
  }

  /* Digiforma-friendly wrapper */
  .outer-container{
    width:100%;
    display:flex;
    justify-content:center;
    padding:22px 14px 34px;
  }
  .app{
    width:min(980px, 100%);
    background: var(--card);
    border:1px solid var(--line);
    border-radius: calc(var(--radius) + 6px);
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  header{
    padding:18px 18px 14px;
    background:
      radial-gradient(900px 240px at 20% 0%, rgba(20,120,108,.16), transparent 55%),
      radial-gradient(900px 240px at 85% 10%, rgba(237,176,26,.20), transparent 55%),
      linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.85));
    border-bottom:1px solid var(--line);
  }
  .topline{
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .brand h1{
    font-size:22px;
    letter-spacing:.2px;
    line-height:1.15;
  }
  .brand .sub{
    color:var(--muted);
    font-size:13px;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border:1px solid var(--line);
    border-radius:999px;
    background:rgba(255,255,255,.75);
    font-size:12px;
    color:var(--muted);
  }
  .dot{
    width:10px;height:10px;border-radius:999px;
    background: conic-gradient(from 0deg, var(--teal), var(--amber), var(--teal));
  }

  .content{
    padding:16px 18px 20px;
  }

  /* Progress */
  .steps{
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:10px;
    margin-bottom:14px;
  }
  .step{
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 10px;
    background:#fff;
    display:flex;
    gap:8px;
    align-items:center;
    min-height:44px;
  }
  .step .n{
    width:24px;height:24px;border-radius:8px;
    display:flex;align-items:center;justify-content:center;
    font-weight:700;
    font-size:12px;
    border:1px solid var(--line);
    background:rgba(15,23,42,.03);
    color:var(--muted);
    flex:0 0 auto;
  }
  .step .t{
    font-size:12px;
    color:var(--muted);
    line-height:1.2;
  }
  .step.active{
    border-color:rgba(20,120,108,.35);
    box-shadow: 0 10px 18px rgba(20,120,108,.10);
  }
  .step.active .n{
    background:rgba(20,120,108,.10);
    border-color:rgba(20,120,108,.30);
    color:var(--teal);
  }
  .step.done .n{
    background:rgba(20,120,108,.14);
    border-color:rgba(20,120,108,.30);
    color:var(--teal);
  }

  /* Panels */
  .panel{
    border:1px solid var(--line);
    border-radius: var(--radius);
    padding:14px;
    background: #fff;
  }
  .panel + .panel{ margin-top:12px; }

  .panel h2{
    font-size:16px;
    margin-bottom:6px;
  }
  .hint{
    color:var(--muted);
    font-size:13px;
    line-height:1.45;
  }

  .card-big{
    margin-top:12px;
    border:1px solid rgba(20,120,108,.25);
    background: rgba(20,120,108,.06);
    border-radius: var(--radius);
    padding:14px;
    position:relative;
    overflow:hidden;
  }
  .card-big:before{
    content:"";
    position:absolute; inset:-40px -40px auto auto;
    width:160px; height:160px;
    border-radius:999px;
    background: radial-gradient(circle at 35% 35%, rgba(237,176,26,.35), transparent 55%);
    filter: blur(0px);
    pointer-events:none;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(20,120,108,.25);
    background: rgba(255,255,255,.6);
    color:var(--teal);
    font-weight:700;
    font-size:12px;
  }
  .card-text{
    margin-top:10px;
    font-size:16px;
    line-height:1.5;
  }

  .grid{
    margin-top:12px;
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width: 840px){
    .steps{ grid-template-columns: 1fr; }
    .grid{ grid-template-columns: 1fr; }
  }

  .choice{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
    background:#fff;
    cursor:pointer;
    transition: transform .08s ease, box-shadow .08s ease, border-color .08s ease;
    user-select:none;
  }
  .choice:hover{
    transform: translateY(-1px);
    box-shadow: 0 10px 18px rgba(2,6,23,.06);
  }
  .choice.selected{
    border-color: rgba(20,120,108,.45);
    background: rgba(20,120,108,.06);
  }

  .choice .title{
    font-weight:700;
    font-size:14px;
    line-height:1.25;
    margin-bottom:6px;
  }
  .choice .desc{
    font-size:12.5px;
    line-height:1.4;
    color:var(--muted);
  }

  .actions{
    margin-top:12px;
    display:flex;
    gap:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
  }
  button{
    appearance:none;
    border:1px solid var(--line);
    background:#fff;
    border-radius:14px;
    padding:10px 12px;
    font-weight:700;
    cursor:pointer;
    transition: transform .08s ease, box-shadow .08s ease, border-color .08s ease;
  }
  button:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(2,6,23,.06); }
  button:disabled{ opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
  .primary{
    border-color: rgba(20,120,108,.35);
    background: linear-gradient(180deg, rgba(20,120,108,.10), rgba(20,120,108,.06));
    color: var(--teal);
  }
  .ghost{
    background: #fff;
    color: var(--muted);
  }
  .danger{
    border-color: rgba(220, 38, 38, .28);
    background: rgba(220, 38, 38, .06);
    color: rgb(185, 28, 28);
  }

  .feedback{
    margin-top:12px;
    border-radius:16px;
    border:1px solid var(--line);
    padding:12px;
    background:#fff;
  }
  .fb-row{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:8px 10px;
    border-radius:14px;
  }
  .fb-row + .fb-row{ margin-top:6px; }
  .tag{
    font-size:11px;
    font-weight:800;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    flex:0 0 auto;
  }
  .ok{ background: var(--good); border-color: rgba(20,120,108,.25); color: var(--teal); }
  .no{ background: var(--bad); border-color: rgba(220,38,38,.22); color: rgb(185,28,28); }
  .info{ background: var(--info); border-color: rgba(2,132,199,.22); color: rgb(2,132,199); }

  .small{
    font-size:12.5px;
    color:var(--muted);
    line-height:1.45;
  }

  .footer-note{
    margin-top:14px;
    padding:12px 14px;
    border-top:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(247,250,249,.9));
    color: var(--muted);
    font-size:12.5px;
    line-height:1.45;
  }
  .k{
    display:inline-flex;align-items:center;gap:8px;
    font-weight:800;color:var(--ink);
  }
  .k b{ color:var(--teal); }
  a{ color:inherit; }
</style>
</head>

<body>
  <div class="outer-container">
    <div class="app" role="application" aria-label="Jeu REBOND - Prototype puzzle">
      <header>
        <div class="topline">
          <div class="brand">
            <h1>ðŸ§© REBOND â€” Puzzle Â« ReconnaÃ®tre & agir Â»</h1>
            <div class="sub">Prototype e-learning (1 situation). Outil de discussion â€” pas un test.</div>
          </div>
          <div class="pill" title="Prototype">
            <span class="dot" aria-hidden="true"></span>
            <span>Progression guidÃ©e â€¢ Multi-sÃ©lection</span>
          </div>
        </div>
      </header>

      <div class="content">
        <!-- Progress -->
        <div class="steps" aria-label="Ã‰tapes">
          <div class="step" id="step-0"><div class="n">0</div><div class="t">Cadre</div></div>
          <div class="step" id="step-1"><div class="n">1</div><div class="t">Situation</div></div>
          <div class="step" id="step-2"><div class="n">2</div><div class="t">Type(s) de violences</div></div>
          <div class="step" id="step-3"><div class="n">3</div><div class="t">Qualification pÃ©nale</div></div>
          <div class="step" id="step-4"><div class="n">4</div><div class="t">Obligations & rÃ©actions</div></div>
        </div>

        <!-- Screen: intro -->
        <section class="panel" id="screen-intro">
          <h2>Cadre de travail</h2>
          <p class="hint">
            Nous travaillons Ã  partir dâ€™une <b>situation fictive</b>. Il ne sâ€™agit pas de juger des personnes,
            mais dâ€™apprendre Ã  <b>repÃ©rer</b>, <b>nommer</b> et <b>protÃ©ger</b>.
            <br/>Personne nâ€™est obligÃ© de partager une expÃ©rience personnelle.
          </p>

          <div class="card-big" style="margin-top:12px;">
            <span class="badge">ðŸ§  Rappel</span>
            <div class="card-text">
              Le rÃ´le dâ€™un encadrant nâ€™est pas dâ€™enquÃªter, mais de <b>protÃ©ger</b> et dâ€™<b>orienter</b>.
              En cas de doute, on privilÃ©gie toujours la protection du mineur.
            </div>
          </div>

          <div class="actions">
            <button class="primary" id="btn-start">Commencer</button>
          </div>
        </section>

        <!-- Screen: situation -->
        <section class="panel" id="screen-situation" hidden>
          <h2>ðŸŸ¥ Carte SITUATION</h2>
          <p class="hint">Lecture puis question au groupe : <b>Â« Que se passe-t-il ? Est-ce normal ? Â»</b></p>

          <div class="card-big" aria-label="Carte situation">
            <span class="badge" id="situation-id">S1</span>
            <div class="card-text" id="situation-text"></div>
          </div>

          <div class="actions">
            <button class="ghost" id="btn-restart-1">Revenir au cadre</button>
            <button class="primary" id="btn-to-violences">Identifier la / les violences</button>
          </div>
        </section>

        <!-- Screen: violences -->
        <section class="panel" id="screen-violences" hidden>
          <h2>ðŸŸ§ PiÃ¨ce 1/3 â€” Type(s) de violences</h2>
          <p class="hint">
            SÃ©lection multiple. Objectif : <b>nommer ce qui nâ€™est pas normal</b>.
          </p>

          <div class="grid" id="violences-grid" aria-label="Choix types de violences"></div>

          <div class="actions">
            <button class="ghost" id="btn-back-to-situation">Retour</button>
            <button class="primary" id="btn-check-violences" disabled>Valider</button>
          </div>

          <div class="feedback" id="violences-feedback" hidden aria-live="polite"></div>

          <div class="actions" style="margin-top:10px;">
            <button class="primary" id="btn-to-penal" disabled>Continuer : qualification pÃ©nale</button>
          </div>
        </section>

        <!-- Screen: penal -->
        <section class="panel" id="screen-penal" hidden>
          <h2>ðŸŸ¨ PiÃ¨ce 2/3 â€” Qualification pÃ©nale</h2>
          <p class="hint">
            SÃ©lection multiple possible. Rappel : une situation peut relever de <b>plusieurs</b> infractions.
          </p>

          <div class="grid" id="penal-grid" aria-label="Choix qualifications pÃ©nales"></div>

          <div class="actions">
            <button class="ghost" id="btn-back-to-violences">Retour</button>
            <button class="primary" id="btn-check-penal" disabled>Valider</button>
          </div>

          <div class="feedback" id="penal-feedback" hidden aria-live="polite"></div>

          <div class="actions" style="margin-top:10px;">
            <button class="primary" id="btn-to-reactions" disabled>Continuer : rÃ©actions attendues</button>
          </div>
        </section>

        <!-- Screen: reactions -->
        <section class="panel" id="screen-reactions" hidden>
          <h2>ðŸŸ© PiÃ¨ce 3/3 â€” Obligations & rÃ©actions</h2>
          <p class="hint">
            Objectif : passer de la reconnaissance Ã  lâ€™action.
            <br/><b>On protÃ¨ge, on trace, on oriente / signale.</b> On nâ€™enquÃªte pas.
          </p>

          <div class="grid" id="reactions-grid" aria-label="Choix obligations et rÃ©actions"></div>

          <div class="actions">
            <button class="ghost" id="btn-back-to-penal">Retour</button>
            <button class="primary" id="btn-check-reactions" disabled>Valider</button>
          </div>

          <div class="feedback" id="reactions-feedback" hidden aria-live="polite"></div>

          <div class="actions" style="margin-top:10px;">
            <button class="primary" id="btn-finish" disabled>Terminer : carte Vrai/Faux</button>
          </div>
        </section>

        <!-- Screen: vrai/faux -->
        <section class="panel" id="screen-vf" hidden>
          <h2>ðŸŸ¦ Carte VRAI / FAUX</h2>
          <p class="hint">Lecture collective puis ancrage du message clÃ©.</p>

          <div class="card-big">
            <span class="badge">Vrai / Faux</span>
            <div class="card-text" id="vf-text"></div>
          </div>

          <div class="panel" style="margin-top:12px;">
            <h2 style="font-size:14px;">Ta rÃ©ponse</h2>
            <div class="actions" style="justify-content:flex-start;margin-top:10px;">
              <button class="primary" id="btn-vrai">VRAI</button>
              <button class="primary" id="btn-faux">FAUX</button>
            </div>

            <div class="feedback" id="vf-feedback" hidden aria-live="polite"></div>
          </div>

          <div class="actions">
            <button class="ghost" id="btn-replay">Rejouer (mÃªme situation)</button>
          </div>
        </section>

      </div>

      <div class="footer-note">
        <span class="k">ðŸ“Œ Message final : <b>protÃ©ger</b> un mineur est une obligation lÃ©gale et morale â€” <b>signaler</b>, câ€™est protÃ©ger.</span><br/>
        NumÃ©ros utiles : 119 â€¢ 17 â€¢ 3018
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------------------------
  // DATA (prototype : 1 situation)
  // ---------------------------
  const SITUATION = {
    id: "S1",
    texte: "Un entraÃ®neur crie rÃ©guliÃ¨rement sur un jeune sportif et lâ€™insulte devant le groupe en cas dâ€™erreur."
  };

  // Types de violences (subset + dÃ©finitions)
  const VIOLENCES = [
    {
      id: "vp",
      title: "Violence psychologique",
      desc: "Comportements (cris, dÃ©nigrement, pression) qui atteignent lâ€™Ã©quilibre et la sÃ©curitÃ© Ã©motionnelle.",
      verdict: "ok",
      why: "Les insultes et la rÃ©pÃ©tition dâ€™un climat humiliant relÃ¨vent dâ€™une violence psychologique."
    },
    {
      id: "hum",
      title: "Humiliation",
      desc: "Rabaisser publiquement, ridiculiser, dÃ©valoriser une personne.",
      verdict: "ok",
      why: "Insulter devant le groupe met en scÃ¨ne une humiliation, souvent trÃ¨s impactante pour un mineur."
    },
    {
      id: "int",
      title: "Intimidation",
      desc: "Instaurer la peur pour obtenir obÃ©issance ou contrÃ´le.",
      verdict: "info",
      why: "Selon le contexte, les cris peuvent instaurer un climat de peur ; cela peut relever de lâ€™intimidation."
    },
    {
      id: "phys",
      title: "Violence physique",
      desc: "Atteintes corporelles (coups, contraintes physiques, douleur infligÃ©e).",
      verdict: "no",
      why: "Ici, il nâ€™y a pas dâ€™atteinte corporelle dÃ©crite : on est sur de la violence verbale/psychologique."
    },
    {
      id: "hs",
      title: "HarcÃ¨lement sexuel",
      desc: "Propos/comportements sexuels ou sexistes rÃ©pÃ©tÃ©s imposÃ©s, crÃ©ant une situation intimidante/hostile.",
      verdict: "no",
      why: "Cette situation ne dÃ©crit pas de propos ou comportements Ã  connotation sexuelle."
    },
    {
      id: "aau",
      title: "Abus dâ€™autoritÃ©",
      desc: "Utiliser sa position dâ€™adulte/encadrant pour imposer, faire taire, contrÃ´ler, humilier.",
      verdict: "info",
      why: "Souvent associÃ© : lâ€™encadrant use de sa position pour imposer une domination (Ã  discuter avec le groupe)."
    }
  ];

  // Qualifications pÃ©nales (subset + repÃ¨res)
  const PENAL = [
    {
      id: "harc_m",
      title: "HarcÃ¨lement moral â€” Art. 222-16-2-2 CP",
      desc: "Agissements rÃ©pÃ©tÃ©s entraÃ®nant une dÃ©gradation des conditions de vie/santÃ© (selon contexte).",
      verdict: "info",
      why: "La rÃ©pÃ©tition est un indice. La qualification dÃ©pendra des Ã©lÃ©ments (durÃ©e, consÃ©quences, etc.)."
    },
    {
      id: "viol",
      title: "Violences volontaires â€” Art. 222-7 Ã  222-14-2 CP",
      desc: "Peut inclure des violences non physiques selon circonstances (Ã  manier avec prudence).",
      verdict: "info",
      why: "Ã€ discuter : selon la situation, certains faits peuvent relever de violences (notamment si menaces/contraintes)."
    },
    {
      id: "men",
      title: "Menaces â€” Art. 222-16 CP",
      desc: "Menaces de commettre un crime/dÃ©lit contre une personne (Ã©lÃ©ments prÃ©cis requis).",
      verdict: "no",
      why: "Ici, aucune menace explicite nâ€™est dÃ©crite ; plutÃ´t des insultes/humiliations."
    },
    {
      id: "hs",
      title: "HarcÃ¨lement sexuel â€” Art. 222-33-2-2 CP",
      desc: "Propos/comportements Ã  connotation sexuelle ou sexiste rÃ©pÃ©tÃ©s.",
      verdict: "no",
      why: "Aucun Ã©lÃ©ment sexuel/sexiste nâ€™est dÃ©crit dans cette situation."
    },
    {
      id: "multi",
      title: "Infractions multiples possibles",
      desc: "Rappel pÃ©dagogique : plusieurs qualifications peuvent se cumuler selon les faits.",
      verdict: "ok",
      why: "Bon rÃ©flexe : ne pas rÃ©duire la situation Ã  une seule lecture â€” et ne pas Â« juger Â» soi-mÃªme."
    }
  ];

  // Obligations & rÃ©actions (subset + repÃ¨res)
  const REACTIONS = [
    {
      id: "prot",
      title: "Obligation de protection du mineur",
      desc: "PrioritÃ© : sÃ©curitÃ©, prÃ©vention, mise Ã  lâ€™abri si besoin.",
      verdict: "ok",
      why: "Le premier rÃ©flexe est de protÃ©ger et dâ€™Ã©viter la poursuite des faits."
    },
    {
      id: "ecoute",
      title: "Ã‰coute sans jugement",
      desc: "Accueillir la parole sans minimiser ni contester.",
      verdict: "ok",
      why: "Une posture dâ€™Ã©coute favorise la parole et rÃ©duit le risque dâ€™isolement."
    },
    {
      id: "trace",
      title: "TraÃ§abilitÃ© des alertes",
      desc: "Noter date, lieu, faits rapportÃ©s, tÃ©moins Ã©ventuels, Ã©lÃ©ments objectifs.",
      verdict: "ok",
      why: "Tracer aide Ã  sÃ©curiser la suite (sans enquÃªter) et Ã  transmettre aux personnes compÃ©tentes."
    },
    {
      id: "secret",
      title: "Ne pas promettre le secret",
      desc: "Expliquer quâ€™on cherchera de lâ€™aide pour protÃ©ger.",
      verdict: "ok",
      why: "Promettre le secret peut empÃªcher la protection et vous mettre en difficultÃ©."
    },
    {
      id: "confr",
      title: "Confronter lâ€™entraÃ®neur sur le moment",
      desc: "Face-Ã -face direct avec la personne mise en cause.",
      verdict: "no",
      why: "Ã‰viter la confrontation directe : risque dâ€™escalade, de pressions, de reprÃ©sailles."
    },
    {
      id: "enquete",
      title: "Mener sa propre enquÃªte",
      desc: "Chercher des preuves / interroger tout le monde pour Ã©tablir les faits.",
      verdict: "no",
      why: "Le rÃ´le nâ€™est pas dâ€™enquÃªter : on protÃ¨ge, on oriente, on signale selon procÃ©dures."
    },
    {
      id: "orient",
      title: "Se tourner vers une personne formÃ©e / rÃ©fÃ©rent",
      desc: "RÃ©fÃ©rent intÃ©gritÃ©, direction, personnes habilitÃ©es.",
      verdict: "info",
      why: "Bon rÃ©flexe organisationnel, en complÃ©ment de la protection et du signalement si nÃ©cessaire."
    }
  ];

  // Vrai/Faux (1 carte prototype)
  const VF = {
    text: "Â« La performance justifie tout Â»",
    answer: false,
    explanation:
      "FAUX. La performance ne justifie jamais des insultes, humiliations ou violences. Le cadre sportif nâ€™est pas un espace hors-la-loi : la protection des mineurs prime."
  };

  // ---------------------------
  // STATE
  // ---------------------------
  const state = {
    step: 0,
    selectedViolences: new Set(),
    selectedPenal: new Set(),
    selectedReactions: new Set(),
    checked: { v:false, p:false, r:false },
    vfAnswered: false
  };

  // ---------------------------
  // HELPERS
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  function setStep(n){
    state.step = n;

    // screens
    $("screen-intro").hidden = n !== 0;
    $("screen-situation").hidden = n !== 1;
    $("screen-violences").hidden = n !== 2;
    $("screen-penal").hidden = n !== 3;
    $("screen-reactions").hidden = n !== 4;
    $("screen-vf").hidden = n !== 5;

    // step UI
    for(let i=0;i<=4;i++){
      const el = $("step-" + i);
      el.classList.remove("active");
      el.classList.remove("done");
      if(i === n) el.classList.add("active");
      if(i < n) el.classList.add("done");
    }
  }

  function makeChoiceCard(item, group, selectedSet){
    const div = document.createElement("div");
    div.className = "choice";
    div.setAttribute("role","button");
    div.setAttribute("tabindex","0");
    div.dataset.id = item.id;

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = item.title;

    const desc = document.createElement("div");
    desc.className = "desc";
    desc.textContent = item.desc;

    div.appendChild(title);
    div.appendChild(desc);

    function toggle(){
      if(selectedSet.has(item.id)) selectedSet.delete(item.id);
      else selectedSet.add(item.id);
      div.classList.toggle("selected", selectedSet.has(item.id));
      updateValidateButtons();
    }

    div.addEventListener("click", toggle);
    div.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggle();
      }
    });

    return div;
  }

  function renderGrid(gridEl, items, selectedSet){
    gridEl.innerHTML = "";
    items.forEach(it => {
      gridEl.appendChild(makeChoiceCard(it, gridEl.id, selectedSet));
    });
  }

  function feedbackBlock(items, selectedSet){
    const wrap = document.createElement("div");

    // show selected first, then missed "ok" that could be useful
    const selectedItems = items.filter(it => selectedSet.has(it.id));
    const missedOk = items.filter(it => it.verdict === "ok" && !selectedSet.has(it.id));

    function row(tagClass, tagText, title, why){
      const r = document.createElement("div");
      r.className = "fb-row";
      const tag = document.createElement("div");
      tag.className = "tag " + tagClass;
      tag.textContent = tagText;

      const txt = document.createElement("div");
      const t = document.createElement("div");
      t.style.fontWeight = "800";
      t.style.fontSize = "13px";
      t.textContent = title;

      const p = document.createElement("div");
      p.className = "small";
      p.textContent = why;

      txt.appendChild(t);
      txt.appendChild(p);

      r.appendChild(tag);
      r.appendChild(txt);
      return r;
    }

    if(selectedItems.length === 0){
      wrap.appendChild(row("info","INFO","Aucune sÃ©lection", "SÃ©lectionne au moins une carte pour avancer."));
      return wrap;
    }

    selectedItems.forEach(it => {
      if(it.verdict === "ok") wrap.appendChild(row("ok","OK", it.title, it.why));
      else if(it.verdict === "no") wrap.appendChild(row("no","Ã€ REVOIR", it.title, it.why));
      else wrap.appendChild(row("info","Ã€ DISCUTER", it.title, it.why));
    });

    if(missedOk.length){
      missedOk.forEach(it => {
        wrap.appendChild(row("info","SUGGESTION", it.title, "Vous pouvez aussi lâ€™envisager : " + it.why));
      });
    }

    return wrap;
  }

  function updateValidateButtons(){
    $("btn-check-violences").disabled = state.selectedViolences.size === 0;
    $("btn-check-penal").disabled = state.selectedPenal.size === 0;
    $("btn-check-reactions").disabled = state.selectedReactions.size === 0;
  }

  function resetAll(){
    state.step = 0;
    state.selectedViolences.clear();
    state.selectedPenal.clear();
    state.selectedReactions.clear();
    state.checked = { v:false, p:false, r:false };
    state.vfAnswered = false;

    $("violences-feedback").hidden = true;
    $("penal-feedback").hidden = true;
    $("reactions-feedback").hidden = true;
    $("vf-feedback").hidden = true;

    $("btn-to-penal").disabled = true;
    $("btn-to-reactions").disabled = true;
    $("btn-finish").disabled = true;

    // rerender
    $("situation-id").textContent = SITUATION.id;
    $("situation-text").textContent = SITUATION.texte;

    renderGrid($("violences-grid"), VIOLENCES, state.selectedViolences);
    renderGrid($("penal-grid"), PENAL, state.selectedPenal);
    renderGrid($("reactions-grid"), REACTIONS, state.selectedReactions);

    $("vf-text").textContent = VF.text;
    updateValidateButtons();
    setStep(0);
  }

  // ---------------------------
  // EVENTS
  // ---------------------------
  $("btn-start").addEventListener("click", () => setStep(1));
  $("btn-restart-1").addEventListener("click", () => setStep(0));

  $("btn-to-violences").addEventListener("click", () => setStep(2));
  $("btn-back-to-situation").addEventListener("click", () => setStep(1));

  $("btn-back-to-violences").addEventListener("click", () => setStep(2));
  $("btn-back-to-penal").addEventListener("click", () => setStep(3));

  $("btn-check-violences").addEventListener("click", () => {
    const fb = $("violences-feedback");
    fb.innerHTML = "";
    fb.appendChild(feedbackBlock(VIOLENCES, state.selectedViolences));
    fb.hidden = false;
    state.checked.v = true;
    $("btn-to-penal").disabled = false;
  });

  $("btn-to-penal").addEventListener("click", () => setStep(3));

  $("btn-check-penal").addEventListener("click", () => {
    const fb = $("penal-feedback");
    fb.innerHTML = "";
    fb.appendChild(feedbackBlock(PENAL, state.selectedPenal));
    fb.hidden = false;
    state.checked.p = true;
    $("btn-to-reactions").disabled = false;
  });

  $("btn-to-reactions").addEventListener("click", () => setStep(4));

  $("btn-check-reactions").addEventListener("click", () => {
    const fb = $("reactions-feedback");
    fb.innerHTML = "";
    fb.appendChild(feedbackBlock(REACTIONS, state.selectedReactions));
    fb.hidden = false;
    state.checked.r = true;
    $("btn-finish").disabled = false;
  });

  $("btn-finish").addEventListener("click", () => setStep(5));

  function answerVF(val){
    if(state.vfAnswered) return;
    state.vfAnswered = true;

    const fb = $("vf-feedback");
    fb.hidden = false;
    fb.innerHTML = "";

    const correct = (val === VF.answer);
    const row = document.createElement("div");
    row.className = "fb-row";
    const tag = document.createElement("div");
    tag.className = "tag " + (correct ? "ok" : "info");
    tag.textContent = correct ? "OK" : "Ã€ RETENIR";

    const txt = document.createElement("div");
    const t = document.createElement("div");
    t.style.fontWeight = "900";
    t.style.fontSize = "13px";
    t.textContent = VF.explanation;

    const p = document.createElement("div");
    p.className = "small";
    p.textContent = "Message clÃ© : protÃ©ger un mineur prime. Signaler, ce nâ€™est pas accuser â€” câ€™est protÃ©ger.";

    txt.appendChild(t);
    txt.appendChild(p);
    row.appendChild(tag);
    row.appendChild(txt);
    fb.appendChild(row);

    // disable buttons
    $("btn-vrai").disabled = true;
    $("btn-faux").disabled = true;
  }

  $("btn-vrai").addEventListener("click", () => answerVF(true));
  $("btn-faux").addEventListener("click", () => answerVF(false));

  $("btn-replay").addEventListener("click", () => {
    // keep the same situation, reset selections only
    $("btn-vrai").disabled = false;
    $("btn-faux").disabled = false;
    resetAll();
    setStep(1);
  });

  // init
  resetAll();
})();
</script>
</body>
</html>
    
  </body>
  
</html>
